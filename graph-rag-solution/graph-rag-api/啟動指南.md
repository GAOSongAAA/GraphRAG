# Graph RAG 項目啟動指南

## 快速啟動

### 方法一：使用 Maven 啟動（推薦）

```bash
# 1. 進入項目根目錄
cd graph-rag-solution

# 2. 設置環境變量
export OPENAI_API_KEY="your-openai-api-key"
export NEO4J_PASSWORD="password123"

# 3. 啟動基礎設施（Neo4j 和 Redis）
docker-compose up -d neo4j redis

# 4. 等待 Neo4j 啟動完成（約 30 秒）
docker-compose logs -f neo4j

# 5. 編譯項目
mvn clean compile -DskipTests

# 6. 啟動 API 服務
mvn spring-boot:run -pl graph-rag-api
```

### 方法二：使用 JAR 包啟動

```bash
# 1. 編譯打包
mvn clean package -DskipTests

# 2. 啟動應用
java -jar graph-rag-api/target/graph-rag-api-1.0.0-SNAPSHOT.jar
```

### 方法三：使用 Docker Compose 啟動全套服務

```bash
# 1. 設置環境變量
export OPENAI_API_KEY="your-openai-api-key"

# 2. 啟動所有服務
docker-compose up -d

# 3. 查看服務狀態
docker-compose ps
```

## 環境變量配置

創建 `.env` 文件：

```bash
# OpenAI API 配置
OPENAI_API_KEY=your-openai-api-key
OPENAI_BASE_URL=https://api.openai.com/v1

# Neo4j 配置
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=password123

# Redis 配置
REDIS_PASSWORD=redis123

# 應用配置
SPRING_PROFILES_ACTIVE=dev
```

## 啟動後驗證

### 1. 檢查服務健康狀態

```bash
# 健康檢查
curl http://localhost:8080/api/v1/graph-rag/health

# 預期響應
{
  "success": true,
  "data": {
    "status": "healthy",
    "components": {
      "database": {"status": "up"},
      "cache": {"status": "up"}
    }
  }
}
```

### 2. 查看 Swagger 文檔

訪問：http://localhost:8080/swagger-ui.html

### 3. 測試 API 接口

```bash
# 簡單查詢測試
curl -X POST http://localhost:8080/api/v1/graph-rag/query \
  -H "Content-Type: application/json" \
  -d '{
    "question": "什麼是人工智能？",
    "retrievalMode": "hybrid",
    "maxDocuments": 5
  }'
```

## 常見問題解決

### 問題 1：Spring Security 登錄頁面

**現象**：訪問任何 API 都跳轉到登錄頁面

**解決方案**：已創建 SecurityConfig 配置類（見下方）

### 問題 2：Neo4j 連接失敗

**現象**：啟動時報 Neo4j 連接錯誤

**解決方案**：
```bash
# 檢查 Neo4j 是否啟動
docker-compose ps neo4j

# 查看 Neo4j 日誌
docker-compose logs neo4j

# 重啟 Neo4j
docker-compose restart neo4j
```

### 問題 3：OpenAI API 調用失敗

**現象**：查詢時報 OpenAI API 錯誤

**解決方案**：
```bash
# 檢查 API Key 是否設置
echo $OPENAI_API_KEY

# 測試 API Key 是否有效
curl -H "Authorization: Bearer $OPENAI_API_KEY" \
  https://api.openai.com/v1/models
```

### 問題 4：端口被占用

**現象**：啟動時報端口 8080 被占用

**解決方案**：
```bash
# 查找占用端口的進程
lsof -i :8080

# 殺死進程
kill -9 <PID>

# 或者修改端口
export SERVER_PORT=8081
mvn spring-boot:run -pl graph-rag-api -Dserver.port=8081
```

## 開發模式啟動

### IDE 中啟動

1. **IntelliJ IDEA**：
   - 打開項目
   - 找到 `GraphRagApiApplication.java`
   - 右鍵 → Run 'GraphRagApiApplication'

2. **Eclipse**：
   - 導入 Maven 項目
   - 右鍵項目 → Run As → Spring Boot App

3. **VS Code**：
   - 安裝 Java Extension Pack
   - 打開項目
   - 按 F5 啟動調試

### 調試模式啟動

```bash
# Maven 調試模式
mvn spring-boot:run -pl graph-rag-api -Dspring-boot.run.jvmArguments="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005"

# 然後在 IDE 中連接到 localhost:5005 進行調試
```

## 生產環境部署

### 使用 Docker

```bash
# 構建鏡像
docker build -t graph-rag:latest .

# 運行容器
docker run -d \
  --name graph-rag-app \
  -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -e OPENAI_API_KEY=$OPENAI_API_KEY \
  graph-rag:latest
```

### 使用 Kubernetes

```bash
# 部署到 K8s
kubectl apply -f k8s-deployment.yaml

# 檢查部署狀態
kubectl get pods -n graph-rag
```

## 監控和日誌

### 查看應用日誌

```bash
# Docker Compose 方式
docker-compose logs -f graph-rag-app

# Maven 方式（日誌在控制台）
tail -f logs/application.log
```

### 監控端點

- 健康檢查：http://localhost:8080/api/v1/graph-rag/health
- 應用信息：http://localhost:8080/actuator/info
- 指標監控：http://localhost:8080/actuator/metrics
- Prometheus：http://localhost:8080/actuator/prometheus

### Grafana 監控面板

訪問：http://localhost:3000
- 用戶名：admin
- 密碼：admin123

## 性能調優

### JVM 參數優化

```bash
export JAVA_OPTS="-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
mvn spring-boot:run -pl graph-rag-api
```

### 數據庫連接池調優

在 `application.yml` 中：

```yaml
spring:
  neo4j:
    pool:
      max-connection-pool-size: 50
      connection-acquisition-timeout: 60s
```

## 故障排查

### 啟動失敗排查步驟

1. 檢查 Java 版本：`java -version`（需要 Java 17+）
2. 檢查 Maven 版本：`mvn -version`
3. 檢查端口占用：`netstat -tulpn | grep 8080`
4. 檢查環境變量：`env | grep OPENAI`
5. 查看詳細錯誤日誌

### 常用排查命令

```bash
# 檢查服務狀態
curl -f http://localhost:8080/api/v1/graph-rag/health || echo "Service not ready"

# 檢查數據庫連接
docker exec -it graph-rag-neo4j cypher-shell -u neo4j -p password123

# 檢查 Redis 連接
docker exec -it graph-rag-redis redis-cli ping

# 查看系統資源
docker stats
```

## 聯繫支持

如果遇到問題，請提供以下信息：

1. 操作系統版本
2. Java 版本
3. 啟動命令
4. 完整錯誤日誌
5. 環境變量配置（隱藏敏感信息）

技術支持：support@graphrag.com 