# Graph RAG 問題解決指南

## 🚀 項目啟動問題

### 問題 1：Spring Security 登錄頁面封鎖

**現象**：
- 訪問任何 API 都跳轉到 `/login` 頁面
- 顯示 Spring Security 默認登錄表單
- 無法訪問 Swagger 文檔或 API 端點

**原因**：
項目引入了 `spring-boot-starter-security` 依賴，但沒有配置 Security 設置，Spring Security 默認啟用表單登錄。

**解決方案**：

#### 方案一：使用已創建的 SecurityConfig（推薦）

我已經為您創建了 `SecurityConfig.java` 配置類，該配置：
- 禁用默認登錄頁面
- 允許所有 API 請求無需認證
- 配置適當的安全頭

文件位置：`graph-rag-api/src/main/java/com/graphrag/api/config/SecurityConfig.java`

#### 方案二：臨時禁用 Security（僅用於測試）

在 `application.yml` 中添加：

```yaml
spring:
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration
```

#### 方案三：配置基本認證（生產環境）

如果需要基本認證，在 `application.yml` 中配置：

```yaml
spring:
  security:
    user:
      name: admin
      password: your-secure-password
      roles: ADMIN
```

### 問題 2：項目啟動失敗

**常見錯誤及解決方案**：

#### 錯誤：Neo4j 連接失敗

```
Failed to obtain connection from pool within configured maximum time
```

**解決方案**：
```bash
# 1. 檢查 Neo4j 是否運行
docker-compose ps neo4j

# 2. 啟動 Neo4j
docker-compose up -d neo4j

# 3. 等待 Neo4j 完全啟動（約 30 秒）
docker-compose logs -f neo4j

# 4. 測試連接
docker-compose exec neo4j cypher-shell -u neo4j -p password123
```

#### 錯誤：端口 8080 被占用

```
Port 8080 was already in use
```

**解決方案**：
```bash
# 方法一：更改端口
export SERVER_PORT=8081
mvn spring-boot:run -pl graph-rag-api -Dserver.port=8081

# 方法二：找到並停止占用進程
lsof -i :8080
kill -9 <PID>
```

#### 錯誤：OpenAI API 調用失敗

```
OpenAI API call failed: Unauthorized
```

**解決方案**：
```bash
# 設置正確的 API Key
export OPENAI_API_KEY="your-real-openai-api-key"

# 測試 API Key 是否有效
curl -H "Authorization: Bearer $OPENAI_API_KEY" \
  https://api.openai.com/v1/models
```

### 問題 3：編譯錯誤

#### 錯誤：Java 版本不兼容

```
Source option 17 is no longer supported. Use 18 or later.
```

**解決方案**：
```bash
# 檢查 Java 版本
java -version

# 確保使用 Java 17 或更高版本
export JAVA_HOME=/path/to/java17
```

#### 錯誤：依賴下載失敗

```
Could not resolve dependencies
```

**解決方案**：
```bash
# 清理並重新下載依賴
mvn clean
mvn dependency:resolve
mvn compile
```

## 🔧 完整啟動流程

### 方法一：快速啟動（推薦）

```bash
# 1. 設置環境變量
export OPENAI_API_KEY="your-openai-api-key"
export NEO4J_PASSWORD="password123"

# 2. 啟動基礎設施
docker-compose up -d neo4j redis

# 3. 等待服務啟動
sleep 30

# 4. 編譯並啟動應用
mvn clean compile -DskipTests
mvn spring-boot:run -pl graph-rag-api
```

### 方法二：使用啟動腳本

```bash
# 使用提供的啟動腳本
./start.sh
```

### 方法三：IDE 中啟動

1. **IntelliJ IDEA**：
   - 設置環境變量：Run Configuration → Environment Variables
   - 添加：`OPENAI_API_KEY=your-key`、`NEO4J_PASSWORD=password123`
   - 運行 `GraphRagApiApplication.main()`

2. **VS Code**：
   - 創建 `.vscode/launch.json`：
   ```json
   {
     "version": "0.2.0",
     "configurations": [
       {
         "type": "java",
         "name": "Graph RAG API",
         "request": "launch",
         "mainClass": "com.graphrag.api.GraphRagApiApplication",
         "env": {
           "OPENAI_API_KEY": "your-key",
           "NEO4J_PASSWORD": "password123"
         }
       }
     ]
   }
   ```

## 🧪 啟動後驗證

### 1. 健康檢查

```bash
curl http://localhost:8080/api/v1/graph-rag/health
```

**預期響應**：
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "components": {
      "database": {"status": "up"},
      "cache": {"status": "up"}
    }
  }
}
```

### 2. Swagger 文檔

訪問：http://localhost:8080/swagger-ui.html

### 3. 測試 API

```bash
curl -X POST http://localhost:8080/api/v1/graph-rag/query \
  -H "Content-Type: application/json" \
  -d '{
    "question": "什麼是人工智能？",
    "retrievalMode": "hybrid",
    "maxDocuments": 5
  }'
```

## 🐛 調試技巧

### 1. 查看詳細日誌

```bash
# Maven 啟動時顯示詳細日誌
mvn spring-boot:run -pl graph-rag-api -X

# 或者設置日誌級別
mvn spring-boot:run -pl graph-rag-api \
  -Dspring-boot.run.jvmArguments="-Dlogging.level.com.graphrag=DEBUG"
```

### 2. 檢查配置

```bash
# 查看當前配置
curl http://localhost:8080/actuator/configprops

# 查看環境變量
curl http://localhost:8080/actuator/env
```

### 3. 監控應用狀態

```bash
# 應用指標
curl http://localhost:8080/actuator/metrics

# JVM 信息
curl http://localhost:8080/actuator/metrics/jvm.memory.used
```

## 🔒 Security 配置詳解

### 當前配置說明

`SecurityConfig.java` 配置了以下安全策略：

1. **禁用 CSRF**：API 服務不需要 CSRF 保護
2. **無狀態會話**：使用 JWT 或無狀態認證
3. **允許的端點**：
   - `/api/v1/graph-rag/health` - 健康檢查
   - `/swagger-ui/**` - API 文檔
   - `/actuator/**` - 監控端點
   - `/api/**` - 所有 API 請求

### 如果需要啟用認證

如果生產環境需要認證，可以修改 `SecurityConfig.java`：

```java
.authorizeHttpRequests(authz -> authz
    .requestMatchers("/api/v1/graph-rag/health").permitAll()
    .requestMatchers("/swagger-ui/**").permitAll()
    .anyRequest().authenticated()
)
.httpBasic(Customizer.withDefaults()) // 啟用基本認證
```

## 📞 獲取幫助

### 常用排查命令

```bash
# 檢查服務狀態
curl -f http://localhost:8080/api/v1/graph-rag/health || echo "Service not ready"

# 檢查端口占用
lsof -i :8080

# 檢查 Java 進程
jps -l | grep GraphRag

# 查看應用日誌
tail -f logs/application.log
```

### 收集診斷信息

如果問題仍然存在，請收集以下信息：

1. **系統信息**：
   ```bash
   uname -a
   java -version
   mvn -version
   docker --version
   ```

2. **環境變量**：
   ```bash
   env | grep -E "(JAVA|MAVEN|OPENAI|NEO4J)"
   ```

3. **錯誤日誌**：
   - 完整的啟動日誌
   - 錯誤堆棧跟踪
   - 相關配置文件內容

4. **網絡連接**：
   ```bash
   curl -v http://localhost:8080/api/v1/graph-rag/health
   ```

### 聯繫支持

- 技術支持：support@graphrag.com
- GitHub Issues：https://github.com/your-org/graph-rag-solution/issues
- 文檔：查看 `docs/` 目錄下的詳細文檔

---

**提示**：大多數啟動問題都是由於環境配置或依賴服務未啟動導致的。請按照上述步驟逐一排查，通常可以快速解決問題。 